@startuml
' Định dạng giấy A4 portrait (210mm x 297mm)
skinparam pageSize 210 297
skinparam pageMargin 30
skinparam defaultFontSize 12

title Place Order Use Case - Sequence Diagram

actor User as "User/Guest"
participant "Frontend" as FE
participant "OrderController" as Controller
participant "OrderService" as Service
participant "CartService" as CartService
participant "ProductService" as ProductService
participant "OrderRepository" as OrderRepo
database "Database" as DB

== User Places Order ==
' User có thể là khách (Guest) hoặc đã đăng nhập
User -> FE : Chọn sản phẩm, nhập thông tin giao hàng
FE -> Controller : POST /orders { cartId, shippingInfo, paymentInfo }
Controller -> Service : placeOrder(dto)
Service -> CartService : getCart(cartId)
CartService -> DB : Query cart
DB --> CartService : Cart
CartService --> Service : Cart

Service -> ProductService : checkStock(cart.items)
ProductService -> DB : Query stock
DB --> ProductService : Stock info
ProductService --> Service : Stock valid/invalid

alt Stock hợp lệ
    Service -> OrderRepo : create order (có thể không có userId nếu là Guest)
    OrderRepo -> DB : Insert order
    DB --> OrderRepo : Order
    OrderRepo --> Service : Order
    Service -> ProductService : updateStock(cart.items)
    ProductService -> DB : Update stock
    DB --> ProductService : OK
    ProductService --> Service : OK
    Service -> CartService : clearCart(cartId)
    CartService -> DB : Delete cart items
    DB --> CartService : OK
    CartService --> Service : OK
    Service --> Controller : { order, success: true }
else Hết hàng
    Service --> Controller : { success: false, message: "Out of stock" }
end
Controller --> FE : 200 OK hoặc lỗi

@enduml
